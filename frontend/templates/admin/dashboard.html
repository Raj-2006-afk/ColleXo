{% extends "base.html" %} {% block title %}Admin Dashboard - ColleXo{% endblock
%} {% block content %}
<div class="dashboard-container">
	<div class="dashboard-header">
		<h2>Admin Dashboard</h2>
		<p>Welcome, <span id="userName"></span>!</p>
	</div>

	<div class="dashboard-tabs">
		<button class="tab-button active" onclick="showTab('stats')">
			Statistics
		</button>
		<button class="tab-button" onclick="showTab('users')">Users</button>
		<button class="tab-button" onclick="showTab('societies')">Societies</button>
	</div>

	<!-- Statistics Tab -->
	<div id="stats-tab" class="tab-content active">
		<div class="stats-grid">
			<div class="stat-card">
				<h3 id="totalUsers">0</h3>
				<p>Total Users</p>
			</div>
			<div class="stat-card">
				<h3 id="totalSocieties">0</h3>
				<p>Total Societies</p>
			</div>
			<div class="stat-card">
				<h3 id="totalForms">0</h3>
				<p>Active Forms</p>
			</div>
			<div class="stat-card">
				<h3 id="totalApplications">0</h3>
				<p>Total Applications</p>
			</div>
		</div>

		<div class="recent-activity">
			<h3>Recent Users</h3>
			<div id="recentUsers"></div>

			<h3>Recent Societies</h3>
			<div id="recentSocieties"></div>
		</div>
	</div>

	<!-- Users Tab -->
	<div id="users-tab" class="tab-content" style="display: none">
		<div class="section-header">
			<h3>All Users</h3>
			<select id="roleFilter" onchange="filterUsers()">
				<option value="">All Roles</option>
				<option value="student">Students</option>
				<option value="societyHead">Society Heads</option>
				<option value="admin">Admins</option>
			</select>
		</div>
		<div id="usersList"></div>
	</div>

	<!-- Societies Tab -->
	<div id="societies-tab" class="tab-content" style="display: none">
		<div class="section-header">
			<h3>All Societies</h3>
		</div>
		<div id="societiesList"></div>
	</div>
</div>

<script>
	const token = localStorage.getItem("token");
	const user = JSON.parse(localStorage.getItem("user") || "{}");

	if (!token || user.user_role !== "admin") {
		window.location.href = "/login";
	}

	document.getElementById("userName").textContent = user.user_name;

	// Tab switching
	function showTab(tabName) {
		const tabs = document.querySelectorAll(".tab-content");
		const buttons = document.querySelectorAll(".tab-button");

		tabs.forEach((tab) => (tab.style.display = "none"));
		buttons.forEach((btn) => btn.classList.remove("active"));

		document.getElementById(tabName + "-tab").style.display = "block";
		event.target.classList.add("active");

		if (tabName === "stats") loadStats();
		else if (tabName === "users") loadUsers();
		else if (tabName === "societies") loadSocieties();
	}

	async function loadStats() {
		try {
			const response = await fetch("/api/admin/dashboard/stats", {
				headers: { Authorization: `Bearer ${token}` },
			});
			const data = await response.json();

			document.getElementById("totalUsers").textContent =
				data.stats.total_users;
			document.getElementById("totalSocieties").textContent =
				data.stats.total_societies;
			document.getElementById("totalForms").textContent =
				data.stats.total_forms;
			document.getElementById("totalApplications").textContent =
				data.stats.total_applications;

			// Display recent users
			const recentUsers = document.getElementById("recentUsers");
			recentUsers.innerHTML = "";
			data.recent_users.forEach((u) => {
				const item = document.createElement("div");
				item.className = "recent-item";
				item.innerHTML = `<p><strong>${u.user_name}</strong> (${u.user_role}) - ${u.user_email}</p>`;
				recentUsers.appendChild(item);
			});

			// Display recent societies
			const recentSocieties = document.getElementById("recentSocieties");
			recentSocieties.innerHTML = "";
			data.recent_societies.forEach((s) => {
				const item = document.createElement("div");
				item.className = "recent-item";
				item.innerHTML = `<p><strong>${s.society_name}</strong> (${s.category}) - Head: ${s.head_name}</p>`;
				recentSocieties.appendChild(item);
			});
		} catch (error) {
			console.error("Error loading stats:", error);
		}
	}

	async function loadUsers() {
		const role = document.getElementById("roleFilter").value;
		const url = "/api/admin/users" + (role ? `?role=${role}` : "");

		try {
			const response = await fetch(url, {
				headers: { Authorization: `Bearer ${token}` },
			});
			const data = await response.json();

			const usersList = document.getElementById("usersList");
			usersList.innerHTML = "";

			if (data.users && data.users.length > 0) {
				const table = document.createElement("table");
				table.className = "data-table";
				table.innerHTML = `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;

				const tbody = table.querySelector("tbody");
				data.users.forEach((u) => {
					const row = document.createElement("tr");
					row.innerHTML = `
                    <td>${u.user_id}</td>
                    <td>${u.user_name}</td>
                    <td>${u.user_email}</td>
                    <td><span class="badge">${u.user_role}</span></td>
                    <td>${
											u.created_at
												? new Date(u.created_at).toLocaleDateString()
												: "N/A"
										}</td>
                `;
					tbody.appendChild(row);
				});

				usersList.appendChild(table);
			} else {
				usersList.innerHTML = "<p>No users found.</p>";
			}
		} catch (error) {
			console.error("Error loading users:", error);
		}
	}

	async function loadSocieties() {
		try {
			const response = await fetch("/api/admin/societies", {
				headers: { Authorization: `Bearer ${token}` },
			});
			const data = await response.json();

			const societiesList = document.getElementById("societiesList");
			societiesList.innerHTML = "";

			if (data.societies && data.societies.length > 0) {
				data.societies.forEach((s) => {
					const card = document.createElement("div");
					card.className = "society-card";
					card.innerHTML = `
                    <h4>${s.society_name}</h4>
                    <p><strong>Category:</strong> ${s.category}</p>
                    <p><strong>Head:</strong> ${s.head_name}</p>
                    <p><strong>Members:</strong> ${s.member_count}</p>
                    <p><strong>Status:</strong> ${
											s.admission_open ? "Open" : "Closed"
										}</p>
                    <button class="btn btn-sm btn-danger" onclick="deleteSociety(${
											s.society_id
										})">Delete</button>
                `;
					societiesList.appendChild(card);
				});
			} else {
				societiesList.innerHTML = "<p>No societies found.</p>";
			}
		} catch (error) {
			console.error("Error loading societies:", error);
		}
	}

	async function deleteSociety(societyId) {
		if (!confirm("Are you sure you want to delete this society?")) return;

		try {
			const response = await fetch(`/api/societies/${societyId}`, {
				method: "DELETE",
				headers: { Authorization: `Bearer ${token}` },
			});

			if (response.ok) {
				alert("Society deleted successfully");
				loadSocieties();
			} else {
				alert("Failed to delete society");
			}
		} catch (error) {
			console.error("Error deleting society:", error);
		}
	}

	function filterUsers() {
		loadUsers();
	}

	// Load initial data
	loadStats();
</script>
{% endblock %}
